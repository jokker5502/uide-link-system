<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="UIDE-Link V2 - Frictionless Bus Telemetry">

    <title>UIDE-Link V2 | Frictionless</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/scanner-ui.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <!-- html5-qrcode library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body style="padding-top: 120px;">

    <!-- Gamification Header -->
    <div class="gamification-header">
        <div class="gamification-stats">
            <div class="stat-item">
                <div class="stat-value" id="totalPoints">0</div>
                <div class="stat-label">Points</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="currentStreak">0</div>
                <div class="stat-label">üî• Streak</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalCO2">0g</div>
                <div class="stat-label">CO‚ÇÇ Saved</div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container-sm">

        <!-- Welcome Card -->
        <div class="card scanner-card-futuristic fade-in">
            <h2 id="welcomeMessage">
                <span class="wave-emoji">üëã</span>
                <span>Bienvenido a UIDE-Link</span>
            </h2>
            <p class="text-muted" style="text-align: center;">
                Escanea el c√≥digo QR del bus para iniciar
            </p>
        </div>

        <!-- Scanner Card -->
        <div class="card scanner-card-futuristic fade-in" style="animation-delay: 0.1s; margin-top: 1.5rem;">

            <!-- Scanner Container -->
            <div id="scannerContainer" class="hidden">
                <div class="scanner-container">
                    <div id="qr-reader"></div>
                </div>

                <div class="text-center mt-3">
                    <button id="stopScanBtn" class="btn btn-secondary">
                        Detener Esc√°ner
                    </button>
                </div>
            </div>

            <!-- Scan Button -->
            <div id="scanButtonContainer">
                <button id="startScanBtn" class="scan-button-instant">
                    üì∑ Escanear C√≥digo QR
                </button>
            </div>
        </div>

        <!-- Destination Selector (shown after scan) -->
        <div id="destinationCard" class="card scanner-card-futuristic hidden" style="margin-top: 1.5rem;">
            <div class="card-header">
                <h3 class="card-title">¬øA d√≥nde vas? (Opcional)</h3>
                <p class="text-muted" style="font-size: 0.875rem;">
                    Toca tu parada o espera 5 segundos
                </p>
            </div>

            <div id="stopsList" class="stops-list">
                <!-- Stops will be dynamically loaded -->
            </div>

            <button id="skipDestinationBtn" class="btn btn-outline btn-full mt-2">
                Omitir
            </button>
        </div>

        <!-- Recent Scans -->
        <div class="card scanner-card-futuristic fade-in" style="animation-delay: 0.2s; margin-top: 1.5rem;">
            <div class="card-header">
                <h3 class="card-title">Viajes Recientes</h3>
            </div>

            <ul id="scanHistory" class="scan-list">
                <li class="text-center text-muted" style="padding: var(--space-lg);">
                    No hay viajes recientes
                </li>
            </ul>
        </div>

        <!-- Achievement Progress (if any) -->
        <div class="achievement-progress fade-in" style="animation-delay: 0.3s; margin-top: 1.5rem;">
            <div class="progress-label" id="progressLabel">
                Escanea para comenzar a ganar puntos
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="achievementProgress" style="width: 0%"></div>
            </div>
        </div>

        <!-- Optional: Profile Link -->
        <div class="text-center" style="margin-top: 2rem; margin-bottom: 2rem;">
            <button id="profileBtn" class="btn btn-outline" style="font-size: 0.875rem;">
                ‚öôÔ∏è Personalizar Perfil
            </button>
        </div>

    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div>
            <div class="spinner"></div>
            <p style="color: white; margin-top: var(--space-md);" id="loadingMessage">Procesando...</p>
        </div>
    </div>

    <!-- Config -->
    <script>
        window.CONFIG = {
            API_URL: 'http://localhost:8000' // Update for production
        };
    </script>

    <!-- Core Scripts -->
    <script src="/js/db.js"></script>
    <script src="/js/sync.js"></script>
    <script src="/js/scanner.js"></script>
    <script src="/js/gamification.js"></script>

    <!-- Main App Script -->
    <script>
        // =====================================
        // UIDE-LINK V2 - FRICTIONLESS APP
        // =====================================

        let sessionToken = null;
        let qrScanner = null;
        let scannedData = null;
        let destinationTimer = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ UIDE-Link V2 Frictionless App starting...');

            // Register Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('‚úì Service Worker registered');
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            }

            // Initialize IndexedDB
            await window.DB.init();

            // Load session token (persistent session)
            const userData = await window.DB.getUserData();
            if (userData && userData.session_token) {
                sessionToken = userData.session_token;
                console.log('‚úì Session restored');

                // Load student summary
                loadStudentSummary();
            }

            // Set up event listeners
            setupEventListeners();

            // Load recent scans
            loadScanHistory();
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('startScanBtn').addEventListener('click', startQRScanner);
            document.getElementById('stopScanBtn').addEventListener('click', stopQRScanner);
            document.getElementById('skipDestinationBtn').addEventListener('click', skipDestination);
            document.getElementById('profileBtn').addEventListener('click', showProfileModal);
        }

        // Start QR scanner
        async function startQRScanner() {
            try {
                if (!qrScanner) {
                    qrScanner = new window.QRScanner();
                    await qrScanner.init('qr-reader', handleQRScan);
                }

                await qrScanner.startScanning();

                document.getElementById('scanButtonContainer').classList.add('hidden');
                document.getElementById('scannerContainer').classList.remove('hidden');

            } catch (error) {
                console.error('Scanner error:', error);
                alert('Error al iniciar c√°mara: ' + error.message);
            }
        }

        // Stop QR scanner
        async function stopQRScanner() {
            if (qrScanner) {
                await qrScanner.stopScanning();
            }

            document.getElementById('scanButtonContainer').classList.remove('hidden');
            document.getElementById('scannerContainer').classList.add('hidden');
        }

        // Handle QR scan - THE INSTANT EXPERIENCE
        async function handleQRScan(qrData) {
            console.log('QR scanned:', qrData);
            scannedData = qrData;

            // Stop scanner
            await stopQRScanner();

            // Send to backend IMMEDIATELY
            await processScan(qrData, null);
        }

        // Process scan with backend
        async function processScan(qrData, destinationStopId = null) {
            showLoading('Procesando...');

            const scanRequest = {
                static_qr_id: qrData.staticQrId,
                scan_type: 'ENTRY',
                client_event_id: window.DB.generateUUID(),
                client_timestamp: qrData.scanTime,
                destination_stop_id: destinationStopId,
                session_token: sessionToken
            };

            try {
                const response = await fetch(`${window.CONFIG.API_URL}/api/scan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scanRequest)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Error al procesar escaneo');
                }

                hideLoading();

                // Save session token
                if (data.session_token) {
                    sessionToken = data.session_token;
                    await window.DB.setUserData({ session_token: sessionToken });
                }

                // Show INSTANT feedback animation
                window.GamificationUI.showPointsAnimation(
                    data.points_earned,
                    data.co2_saved,
                    data.route_name
                );

                // Update gamification display
                window.GamificationUI.updateDisplay({
                    total_points: data.total_points,
                    current_streak: data.current_streak,
                    total_co2_display: data.total_co2_display
                });

                // Check for new achievements
                if (data.new_achievements && data.new_achievements.length > 0) {
                    setTimeout(() => {
                        data.new_achievements.forEach(achievement => {
                            window.GamificationUI.showAchievementBadge({
                                name: achievement,
                                icon: 'üèÜ'
                            });
                        });
                    }, 2000);
                }

                // Update progress bar
                window.GamificationUI.updateProgressBar(data.total_points, 100);

                // Save to history
                await window.DB.addToHistory({
                    ...scanRequest,
                    route_name: data.route_name,
                    bus_number: data.bus_number,
                    points_earned: data.points_earned,
                    localTimestamp: new Date().toISOString(),
                    synced: true
                });

                // Reload history
                await loadScanHistory();

                // Optionally show destination selector (could be removed for ultra-speed)
                // showDestinationSelector(data.route_id);

            } catch (error) {
                hideLoading();
                console.error('Scan processing error:', error);

                // Save offline
                await window.DB.addScan(scanRequest);
                alert('Sin conexi√≥n. Se guard√≥ para sincronizar despu√©s.');
            }
        }

        // Load student summary
        async function loadStudentSummary() {
            if (!sessionToken) return;

            try {
                const response = await fetch(
                    `${window.CONFIG.API_URL}/api/student/summary?session_token=${sessionToken}`
                );

                if (response.ok) {
                    const data = await response.json();
                    window.GamificationUI.updateDisplay(data);
                    window.GamificationUI.updateProgressBar(data.total_points, 100);
                }
            } catch (error) {
                console.error('Failed to load summary:', error);
            }
        }

        // Load scan history
        async function loadScanHistory() {
            const history = await window.DB.getHistory(5);
            const listEl = document.getElementById('scanHistory');

            if (history.length === 0) {
                listEl.innerHTML = '<li class="text-center text-muted" style="padding: var(--space-lg);">No hay viajes recientes</li>';
                return;
            }

            listEl.innerHTML = history.map(scan => {
                const time = new Date(scan.localTimestamp).toLocaleTimeString('es-EC', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <li class="scan-item">
                        <div class="scan-icon entry">üìç</div>
                        <div class="scan-details">
                            <div class="scan-route">${scan.route_name || 'Ruta detectada'}</div>
                            <div class="scan-time">${time} - ${scan.points_earned || 0} pts</div>
                        </div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            ${scan.synced ? '‚úì' : '‚è≥'}
                        </div>
                    </li>
                `;
            }).join('');
        }

        // Show destination selector
        function showDestinationSelector(routeId) {
            // Load stops for route
            // For now, skip this for maximum speed
        }

        // Skip destination
        function skipDestination() {
            document.getElementById('destinationCard').classList.add('hidden');
        }

        // Show profile modal
        function showProfileModal() {
            alert('Perfil personalizaci√≥n - pr√≥ximamente!');
        }

        // Loading overlay
        function showLoading(message = 'Cargando...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

    </script>
</body>

</html>